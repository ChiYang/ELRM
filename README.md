Exploring comprehensive within-motif dependence of transcription factor binding in <i>Escherichia coli</i>
======
##Brief introduction
The ELRM stands for the <u>**E**</u>lastic net regularized <u>**L**</u>ogistic <u>**R**</u>egression <u>**M**</u>odel. 
This modeling approach is used to search within-motif dependence. With the within-motif dependence, 
we aim to construct a concise and informative model to present a TF binding motif. 
Two kinds of features are considered in the model and they are the single-base features and 
association features. A single-base feature describe a nucleotide base occurred at a position 
in a binding motifs and an association feature describe an association between two or 
more single-base features. For example, a single-base feature “C2” describes the 
base C at the second position in a motif, and an association feature “C2:G5” describes an 
association between C2 and G5.

##Requirement
Before you proceed, you need to have **Perl** and **R** installed on your operating systems. 
To perform the approach mentioned in the manuscript, please execute the **Perl** and **R** scripts with 
the following instructions. In addition, an R package, **glmnet**, must be installed before 
running the R scripts. The construction of the ELRM for PurR was used as a demo. 

##Folder structure
  - **data**: The folder contains the data used or generated for the study.
    - AssociationFeatures: The potential association features for the 86 TFs (before selection)
    - ELRMs: The constructed ELRM of the 86 TFs. User can use our visualization tool to visualize the model (please see the Step 6. Visualize the ELRM).
    - TrainingSequences: The training sets containing both positive and negative sequences in the fasta format for ELRM construction.
  - **example**: Files in this folder are used as an example to construct an ELRM and perform sequence analysis. Please see the following section, Steps to build and use the ELRM.
  - **src**: The folder contains the Perl and R scripts  for ELRM construction and sequence analysis.
  - **visualization**:  This contains the interactive user interface for displaying the ELRM graphical representation.  


##Steps to build and use the ELRM
###1. Searching frequently co-occurred single-base features
  - **Script**: `./src/Apriori.pl`
  - **Usage**: `perl Apriori.pl [minimum support] [input fasta file] [output file]`
  - **Description**: This script takes fixed-lengthed DNA sequences in fasta format and searches 
  		the frequently co-occurred single-base features. The first argument is the `minimum support` for 
  		the Apriori algorithm. The support can be seen as the probability of occurring. In the manuscript, 
  		the `minimum support` was set at 0.2. You may lower this `minimum support` to get more frequent 
  		single-base feature sets. The second argument is the input fasta file path and the third argument 
  		is the output file path.
  
	**[Note] This step takes longer time than other stpes, especially when more sequences are in the 
		input file.** In the example, it takes about 5 to 15 miniutes dependes on the computer performance. 
		We have precomputed the output file `./example/Frequent_SingleBase_Sets/PurR.apriori_output` for 
		you, so **you may skip this step**.

  - **Result**: The output file of this script records the resulting frequent single-base feature sets. 
  		In the example, the PurR.fasta file was generated by the PWM scanning on the genome of *E. coli* 
  		K12 strain MG1655 (RefSeq Accession No. NC\_000913.2) and the sequences with scanning score larger 
  		than zero were extracted in fasta format (see the manuscript for detailed information). Therefore, 
  		the output file `./example/Frequent_SingleBase_Sets/PurR.apriori_output` will contain the frequent 
  		single-base feature sets in NC\_000913.2. 
  - **Example**: In the current folder, type

		perl ./src/Apriori.pl 0.2 ./example/PWMscan/PurR.fasta ./example/Frequent_SingleBase_Sets/PurR.apriori_output

###2. Association rule mining
  - **Script**: `./src/FindRules.pl`
  - **Usage**: `perl FindRules.pl [minimum confidence] [MCS] [input file] [output file1] [output file2]`
  - **Description**: 
		The `FindRules.pl` script searches valid positive and negative association rules among 
		the frequent co-occurred single-base feature sets. The valid association rules are 
		defined by the first two arguments, `minimum confidence` and `minimum correlation strength 
		(MCS)`. In the manuscript, these two arguments were set at 0.6 and 0.1, respectively. 
		Lowering these values results in more rules. The third argument is the file path for the 
		frequent single-base feature sets from the output of the `Apriori.pl`. The last two arguments 
		are the two file paths for the two output files.
  - **Result**: Given the `minimum confidence` and the `MCS` to define valid positive and negative 
  		association rules using a VARCC measure, this script generates two output files. The first 
  		one gives a table containing three columns for the valid positive and negative rule, 
  		correlation strength, and the confidence. The second output file lists the association 
  		features. Every association feature in the second output is unique and is generated from 
  		single-base features which form at least one association rule. 
  - **Example**:
		In the current folder, type 

		perl ./src/FindRules.pl 0.6 0.1 ./example/Frequent_SingleBase_Sets/PurR.apriori_output ./example/AssociationRules/PurR.associationRules ./example/AssociationRules/PurR.af

  

###3. Preparing the sequences for constructing ELRM
  - **Script**: `./src/SequenceCoding.pl`
  - **Usage**: `perl SequenceCoding.pl [motif length] [input file] [associationFeature file] [output file] [isTraining]`
  - **Description**: 
		This script converts the sequence file in a fasta format into a matrix format for 
		training ELRMs or for testing. The first argument is to set the motif length and 
		the second is the input fasta file. The third argument is the file from the second 
		output of FindRules.pl script and the fourth argument is the output matrix file. 
		As for the last argument, it is a boolean indicator of training or testing. 
		This argument is set at 1 when converting sequences into a matrix for model training. 
		If the `isTraining` argument is set at 0, it means the sequences will be used for 
		ELRM scanning. In this case, each sequence in the input file will be split into 
		sliding windows with 1bp offset and the length for the sliding window is equal to 
		the motif length. This is for the purpose of ELRM scanning. 
		You may see the output in the example.  

    **[Note] When the script is used to convert sequences into a matrix for training**, it is 
    	important that the title for positive sequences in the fasta file should contain 
    	a **“positive”** word. Otherwise, the sequence will be recognized as a negative 
    	sequence. In addition, the length of input sequences in the input file should be 
    	fixed and the same as the motif length 
    	(please see the file `./example/TrainSeq/PurR.training.fasta` as a reference)

  - **Result**: This script converts DNA sequences into a matrix containing coded-single-base 
  		features and association features for latter use. If the input sequences are used for 
  		training, the resulting matrix contains only essential elements for ELRM construction.
  		You may see the outupt file `./example/TrainSeq/PurR_training.matrix` as a reference.
  - **Example**:
    - For preparing training sets: In the current folder, type

			perl ./src/SequenceCoding.pl 16 ./example/TrainSeq/PurR.training.fasta ./example/AssociationRules/PurR.af ./example/TrainSeq/PurR_training.matrix 1  

    - For preparing sequences to test: In the current folder, type 

			perl ./src/SequenceCoding.pl 16 ./example/TestSeq/PurR_testing.fasta ./example/AssociationRules/PurR.af ./example/TestSeq/PurR_testing.matrix 0

	  - Sequences in PurR_testing.fasta were extracted based on a PurR ChIP-chip study 
	  (Cho, B.K., *et al*. The PurR regulon in Escherichia coli K-12 MG1655. *Nucleic acids research* 2011;39(15):6456-6464).

###4.Training the model
  - **Script**: `./src/GetTheModel.R`
  - **Usage**:  
  For the linux-based or Mac OS, use `R CMD BATCH --vanilla --slave '--args [training matrix] [output ELRM] [α] [s]' ./GetTheModel.R /dev/null`  
  For the windows OS, use `Rscript --vanilla --slave ./GetTheModel.R [training matrix] [output ELRM] [α] [s]`
  - **Description**: 
		This R script requires four arguments. The first argument is the training matrix which 
		can be generated from `SequenceCoding.pl` with the `isTraining` argument set at 1. The 
		second argument indicates the output file path and the third is the `α` value for the
		elastic net regularization. The last arugment `s` is used when training the model and 
		is optional. If the last argument `s` is not set when running the script, the s will be 
		automatically given as the λ value which gives minimum mean cross-validated error when 
		training the model. The script applies the `cv.glmnet` function for the 10-fold cross 
		validation, and each time you run the cross validation, this λ will be slightly different. 
		In order to get the same model, the `s` value to train the current model is recorded in 
		the last row. You can get the same model if you run this script with the last argument 
		equals to the same `s` value. In the manuscript, the `α` value was set at 0.5 and the 
		constrcuted model tends to select correlated groups of features in or out together. 
		When the `α` is set at 1, the lasso regression will be performed and `α` = 0 for ridge 
		regression. You may see 
		<a href="http://web.stanford.edu/~hastie/glmnet/glmnet_alpha.html" target="_blank">
		a documentation page for the `glmnet` package</a> for more information about the `α` and `s`.
  - **Result**: This R script exports the regressed model. The output of this script is the resulting ELRM in a table 
		format. The first column lists the all coded single-base features and the association features, and 
		the second shows the regressed coefficients. In addition, the first row gives the intercept and its value.
		The last row shows the `s` value when training the current model. 
  - **Example**: In the current folder, 
    - For linux or mac users, type

			R CMD BATCH --vanilla --slave '--args ./example/TrainSeq/PurR_training.matrix ./example/TrainSeq/PurR.ELRM.txt 0.5 0.000146174818947755' ./src/GetTheModel.R /dev/null  
	
    - For Windows users, please use the following command
	
			Rscript --vanilla --slave ./src/GetTheModel.R ./example/TrainSeq/PurR_training.matrix ./example/TrainSeq/PurR.ELRM.txt 0.5 0.000146174818947755
				
      **[Note] If the Windows system does not recognize the Rscript command**, you need to find 
      the path for R installation. It is usually in the folder `C:\Program Files\R\<R version>\bin\Rscript`. 
      For example, the path may be `C:\Program Files\R\R-3.1.2\bin\Rscript` and 
      therefore, type the following command instead.

			"C:\Program Files\R\R-3.1.2\bin\Rscript" --vanilla --slave ./src/GetTheModel.R ./example/TrainSeq/PurR_training.matrix ./example/TrainSeq/PurR.ELRM.txt 0.5 0.000146174818947755
			
	- In order to reproduce the models in the manuscript, please use the corresponding optimal λ in the Supplementary Table S1 as the `s` for each TF.

###5. Scan sequences with ELRM
  - **Script**: `./src/ELRMscan.R`
  - **Usage**:  
    For the linux-based or Mac OS, use `R CMD BATCH --vanilla --slave '--args [training matrix] [testing matrix] [output file] [α] [threshold] [s]' ./ELRMscan.R /dev/null`  
    For the Windows OS, use `Rscript --vanilla --slave ./src/ELRMscan.R [training matrix] [testing matrix] [output file] [α] [threshold] [s]`
  - **Description**: 
		This script takes the file paths for the training and testing matrices which generate 
		from the SequenceCoding.pl as the first two arguments. The third argument is the output 
		file path. The fourth and the sixth arguments is the `α` value and the `s` values for 
		performing the elastic net regularization. The `s` argument can be ignored and the script 
		will use the λ value which gives the minimum mean cross-validated error as described in the 
		previous section. It is recommended that you run the `GetTheModel.R` first to get an `s` and 
		pass this `s` for scanning. The scanning results can then be reproduced with the same 
		configuration. As for the fifth argument, `threshold`, can be set to filter out low 
		probability results. The last two arguments, `threshold` and `s`, are optional.
  - **Result**: The scanning results are presented in a tab-delimited format file. 
  		There are six columns in the table and they are the title, start, end, strand, motif, and 
  		probability. Since there are two parameters, `α` and `s`, to construct the ELRM, you may use 
  		different combinations of these two parameters to get different models and scanning results.
  - **Example**: In the current folder,
    - For linux or mac users, type 
	
			R CMD BATCH --vanilla --slave '--args ./example/TrainSeq/PurR_training.matrix ./example/TestSeq/PurR_testing.matrix ./example/ELRMscan/PurR_results.txt 0.5 0.8 0.000146174818947755' ./src/ELRMscan.R /dev/null

    - For Windows users, 
			
			Rscript --vanilla --slave ./src/ELRMscan.R ./example/TrainSeq/PurR_training.matrix ./example/TestSeq/PurR_testing.matrix ./example/ELRMscan/PurR_results.txt 0.5 0.8 0.000146174818947755

		Again, you might want to replace the `Rscript` with your Rscript path, if your Windows OS does not recognize the command.
		
###6. Visualization of the ELRM
  - **Script**: `./visualization/index.html`
  - **Usage**:  
    This is an offline webpage. Go to the `visualization` folder and open the `./visualization/index.html` with any latest browser that supports HTML5. Follow the instructions to view the model. The required model file can be generated by `./src/GetTheModel.R` (Step 4).
  - **Description**: 
	We used the HTML5 canvas to draw the graphical representation of ELRM. This interactive tool allows you to view the model intuitively and quickly test a sequence to see the response probability and features used.
		
###7. Outputs for Cytoscape
  - **Script**:`./src/ConvertELRMtoCytoscape.pl`
  - **Usage**: `perl ConvertELRMtoCytoscape.pl [ELRM file path] [Output file path 1] [Output file path 2]`
  - **Description**: This script converts the ELRM model (form Step 4) to two files for visualization with Cytoscape. Cytoscape is an open source platform for visualization of networks (see the <a href='http://www.cytoscape.org/'>Cytoscape official site</a> for more information).
  - **Result**:  The `Output file path 1` is the edge table file. This file contains four columns: (1) Association feature; (2) Single-base feature 1; (3) Single-base feature 2; and (4) Coefficients for the association feature. When importing the network file into Cytoscape, the second and thrid columns are recognized as edges in the network (Note: the file contains column names at the first line). As for the second output file, the single-base features and their coefficients can be imported as node table file.
   - **Example**: In the current folder, type 

            perl ./src/ConvertELRMtoCytoscape.pl ./example/TrainSeq/PurR.ELRM.txt ./example/Cytoscape/PurR_ELRM.edgeTable ./example/Cytoscape/PurR_ELRM.nodeTable

